<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESP32 Control</title>
  <style>
    body{font-family:system-ui;margin:24px;max-width:520px}
    button{font-size:18px;padding:12px 18px;margin-right:10px;cursor:pointer}
    input{font-size:16px;padding:10px;width:100%;margin:10px 0}
    #log{white-space:pre-wrap;background:#f6f6f6;padding:12px;border-radius:8px}
  </style>
</head>
<body>
  <h2>ESP32 LED Control</h2>
  <label>Device ID (ex: esp1)</label>
  <input id="dev" value="esp1" />
  <label>Token</label>
  <input id="tok" placeholder="API_TOKEN" />
  <div>
    <button onclick="sendLed(1)">LED ON</button>
    <button onclick="sendLed(0)">LED OFF</button>
  </div>
  <p id="state">Disconnected</p>
  <div id="log"></div>

<script>
let ws;
function log(s){ document.getElementById('log').textContent += s + "\\n"; }
function connect(){
  const tok = document.getElementById('tok').value.trim();
  if(!tok){ alert("Pune token-ul"); return; }
  ws = new WebSocket((location.protocol==="https:"?"wss://":"ws://")+location.host+"/ws?role=controller&token="+encodeURIComponent(tok));
  ws.onopen=()=>{ document.getElementById('state').textContent="Connected"; log("connected"); };
  ws.onclose=()=>{ document.getElementById('state').textContent="Disconnected"; log("closed"); };
 ws.onmessage = (e) => {
  const msg = JSON.parse(e.data);
  if (msg.type !== 'hello') { // Adăugăm un filtru pentru a nu afișa mesajele de tip "hello"
    log("<= " + e.data);
  }
};

}
function sendLed(v){
  if(!ws || ws.readyState!==1){ connect(); setTimeout(()=>sendLed(v), 400); return; }
  const to = document.getElementById('dev').value.trim();
  ws.send(JSON.stringify({to, cmd:"led", value:v}));
  log("=> led "+v+" to "+to);
}
</script>
</body>
</html>
