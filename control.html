<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESP32 LED Control</title>
  <style>
    body{font-family:system-ui;margin:24px;max-width:520px}
    button{font-size:18px;padding:12px 18px;margin-right:10px;cursor:pointer}
    input{font-size:16px;padding:10px;width:100%;margin:10px 0}
  </style>
</head>
<body>
  <h2>ESP32 LED Control</h2>
  <label>Device ID (ex: esp1)</label>
  <input id="dev" value="esp1" />
  <div>
    <button onclick="sendLed(1)">LED ON</button>
    <button onclick="sendLed(0)">LED OFF</button>
  </div>
  <p id="state">Disconnected</p>

<script>
let ws;

function connect(){
  ws = new WebSocket((location.protocol==="https:"?"wss://":"ws://")+location.host+"/ws?role=controller");
  
  ws.onopen = () => {
    document.getElementById('state').textContent = "Connected";
  };

  ws.onclose = () => {
    document.getElementById('state').textContent = "Disconnected";
  };

  ws.onmessage = (e) => {
    console.log("<= " + e.data);
  };
}

function sendLed(v) {
  // Check if the WebSocket is not open yet before attempting to connect
  if (!ws || ws.readyState !== 1) {
    connect(); // connect if it's not already connected
    setTimeout(() => sendLed(v), 400); // retry after a short delay
    return;
  }
  const to = document.getElementById('dev').value.trim();
  ws.send(JSON.stringify({ to, cmd: "led", value: v }));
  console.log("=> led " + v + " to " + to);
}

connect(); // Initial connection at the start

</script>
</body>
</html>
